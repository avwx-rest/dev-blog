<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="The developer blog of AVWX"><link href=http://blog.avwx.rest/2019/08-19/ rel=canonical><meta name=author content="Michael duPont"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.5.0"><title>08-19 Stripe Checkout Migration - AVWX Dev Blog</title><link rel=stylesheet href=../../assets/stylesheets/application.1b62728e.css><script src=../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#08-19-stripe-checkout-migration tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=http://blog.avwx.rest title="AVWX Dev Blog" class="md-header-nav__button md-logo"> <i class=md-icon>flight</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> AVWX Dev Blog </span> <span class=md-header-nav__topic> 08-19 Stripe Checkout Migration </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/avwx-rest/avwx-api/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> avwx-rest/avwx-api </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=http://blog.avwx.rest title="AVWX Dev Blog" class="md-nav__button md-logo"> <i class=md-icon>flight</i> </a> AVWX Dev Blog </label> <div class=md-nav__source> <a href=https://github.com/avwx-rest/avwx-api/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> avwx-rest/avwx-api </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title="Blog Home" class=md-nav__link> Blog Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> 2019 </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> 2019 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../08-04/ title="08-04 Server Migration" class=md-nav__link> 08-04 Server Migration </a> </li> <li class=md-nav__item> <a href=../08-05/ title="08-05 Auth Token Rollout" class=md-nav__link> 08-05 Auth Token Rollout </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 08-19 Stripe Checkout Migration </label> <a href=./ title="08-19 Stripe Checkout Migration" class="md-nav__link md-nav__link--active"> 08-19 Stripe Checkout Migration </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#problem class=md-nav__link> Problem </a> </li> <li class=md-nav__item> <a href=#solution class=md-nav__link> Solution </a> </li> <li class=md-nav__item> <a href=#process class=md-nav__link> Process </a> </li> <li class=md-nav__item> <a href=#result class=md-nav__link> Result </a> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> Next Steps </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../09-04/ title="09-04 Hurricane Dorian" class=md-nav__link> 09-04 Hurricane Dorian </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#problem class=md-nav__link> Problem </a> </li> <li class=md-nav__item> <a href=#solution class=md-nav__link> Solution </a> </li> <li class=md-nav__item> <a href=#process class=md-nav__link> Process </a> </li> <li class=md-nav__item> <a href=#result class=md-nav__link> Result </a> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> Next Steps </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/avwx-rest/avwx-api/edit/master/docs/2019/08-19.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=08-19-stripe-checkout-migration>08-19 Stripe Checkout Migration</h1> <p><em>2019-08-19</em></p> <p>Spent the weekend migrating the payment processing system to use Stripe's new Checkout portal.</p> <h2 id=problem>Problem</h2> <p>Stripe's modal Checkout window which is being depricated. AVWX uses this for credit card entry and storage when upgrading to a paid account.</p> <h2 id=solution>Solution</h2> <p>Migrate to the full-page Checkout which will continue being supported and provides additional payment options.</p> <h2 id=process>Process</h2> <p>Stripe offers a <a href=https://stripe.com/docs/payments/checkout/migration>Checkout migration guide</a> to start with. I determined that I was using the dynamic subscription method which requires both frontend and backend changes. This would replace the <code>plans.new_subscription</code> and "Subscribe" button calls with some additional handling.</p> <p>After making the new "Subcribe" button, the page sends a Checkout Session object and redirects the user to the payment page. On success or cancel, Stripe redirects the user to a success or failure endpoint back in the app. They warn not to use the success page to fulfill the request since it doesn't guarentee that the payment went through.</p> <p>They offer a few ways to verify a completed Checkout Session. I opted to register a webhook that would be triggered after a completed session. It first verifies the session in the POST with Stripe to stop any fraudulent calls. It then applies the new customer ID, subscription ID, and plan ID to the user.</p> <p>The user is tracked through this process by passing the user ID to the Check Session object. I tried to use email and existing customer IDs, but these did not guarentee the same user would be found during fulfillment. Stripe sometimes changed the customer ID, and supplying just the email for existing users would create duplicates. I still pass Stripe the email for new customers so I can associate accounts in the Stripe dashboard during support requests.</p> <p>During this process, I also found a bug that prevented free tier users from generating their first token. This was a remnant check when users needed paid accounts to generate a token. This check logic has been fixed and moved into the User class instead of the token view.</p> <h2 id=result>Result</h2> <p>The payment system now redirects users to Stripe to enter their credit card information. Users can now also use Apple Pay with more options available as Stripe adds them with no code changes needed on my part. This upgrade does not affect paid-to-paid and paid-to-free changes. I also fixed a nasty bug for new users.</p> <h2 id=next-steps>Next Steps</h2> <p>A user mentioned that there is no method to update their credit card information without affecting their current plan. That is the next feature I need to address.</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../08-05/ title="08-05 Auth Token Rollout" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> 08-05 Auth Token Rollout </span> </div> </a> <a href=../09-04/ title="09-04 Hurricane Dorian" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> 09-04 Hurricane Dorian </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/avwx-rest class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.a8b5e56f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>